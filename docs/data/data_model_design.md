# Data Model Design

This note captures the current MongoDB footprint for **dp-stock-investment-assistant** and the newly introduced workspace collections. It consolidates the information that previously lived in `README.md` and the `src/data` package so future contributors can reason about the data layer in one place.

## 1. Existing data-layer context

| Area | Source | Notes |
| --- | --- | --- |
| Migrations & schema management | `src/data/migration/db_setup.py`, `src/data/schema/schema_manager.py` | Runs once (or on demand) to create/modify collections, apply JSON schema validation, and build indexes. |
| Core collections (before this change) | `README.md` → “DB setup and migration”, schema files | `market_data`, `symbols`, `fundamental_analysis`, `investment_reports`, `news_events`, `user_preferences`. |
| Repository pattern | `src/data/repositories/` | `mongodb_repository.py` and friends define the base CRUD helpers used by services and routes. |

These pieces remain untouched; we only extended schema coverage so the upcoming workspace/portfolio features have first-class collections with validation and indexes.

## 2. Workspace & portfolio collections (new)

The following collections were added to `src/data/schema/` and wired into `SchemaManager.setup_all_collections()`.

| Collection | Purpose | Key fields |
| --- | --- | --- |
| `groups` | Optional teaming construct above a user. | `name`, `description`. |
| `users` | Analysts interacting with the assistant. | `email`, `name`, `group_id`. |
| `user_profiles` | Lightweight investment mandate per user. | `risk_profile`, `investment_horizon`, `base_currency`, `constraints`. |
| `accounts` | Brokerage / custody accounts. | `user_id`, `name`, `provider`. |
| `investment_styles`, `strategies`, `rules_policies` | Scaffolding for organisational rules. | `name`, `style_id`, `active` (for rules). |
| `workspaces` | Logical working area for a user. | `user_id`, `name`, `description`. |
| `sessions` | Time-boxed collaboration sessions. | `workspace_id`, `title`, `status`, `linked_symbol_ids`. |
| `watchlists` | Symbol groupings per workspace. | `workspace_id`, `symbol_ids`, `description`. |
| `investment_ideas` | Structured thesis artifacts. | `workspace_id`, `title`, `symbol_ids`, `status`, `conviction`. |
| `notes` | Free-form research notes. | `workspace_id`, `session_id`, `type`, `content`, `symbol_ids`. |
| `tasks` | Action items generated by the agent or user. | `workspace_id`, `status`, `priority`, `due_date`. |
| `analyses` | Optional middle layer between sessions and reports. | `session_id`, `title`, `summary`, `symbol_ids`. |
| `reports` | Publishable artifacts bound to a workspace/session/analysis. | `workspace_id`, `session_id`, `analysis_id`, `report_type`, `status`, `symbol_ids`, `generated_at`. |
| `chats` | Individual chat messages. | `session_id`, `role`, `content`. |
| `notifications` | Alerts surfaced to the analyst. | `user_id`, `type`, `message`, `symbol_id`, `read`. |
| `technical_indicators` | Snapshots of indicator values per symbol. | `symbol_id`, `as_of`, `data`. |
| `market_snapshots` | Macro/environment readings for dashboards. | `as_of`, `data`. |
| `portfolios`, `positions`, `trades` | Holdings and executions for the portfolio view. | `user_id`, `portfolio_id`, `symbol_id`, `side`, `quantity`, `price`, `executed_at`. |

All schemas follow the same pattern: JSON schema validation (moderate level, warn action) plus a small set of indexes tuned for obvious query paths. The helper `_setup_standard_collection` in `SchemaManager` keeps creation, validation, and index logic consistent.

## 3. Relationship highlights

- `groups` 1 → * `users` → 1 `user_profiles` / many `workspaces`, `accounts`, `portfolios`, `notifications`.
- `workspaces` 1 → * `sessions`, `watchlists`, `investment_ideas`, `notes`, `tasks`, `analyses`, `chats`.
- `sessions` 1 → * `chats`, `analyses`, `notes`, `tasks` (optional).
- `watchlists`, `investment_ideas`, `notes`, `tasks` all store ticker arrays (`symbol_ids`) so they can reference the canonical `symbols` collection without Mongo joins.
- `portfolios` 1 → many `positions` 1 → many `trades`; each `position` also references `symbols` for lookups.
- `technical_indicators`, `fundamental_analysis`, `market_data`, `market_snapshots` provide analytical context and can be joined in Python via `symbol_id` (referencing the ObjectId of the `symbols` collection, as in `positions`), or via string tickers (`symbol` or `symbol_ids` arrays in other collections). This distinction is important: `positions.symbol_id` uses an ObjectId reference, while collections like `watchlists` and `investment_ideas` use string arrays for tickers.

This keeps the design document-centric (one logical aggregate per collection) while still allowing the application layer to stitch richer views together.

## 4. Implementation & migration notes

1. Run `python src/data/migration/db_setup.py` after pulling these changes. The script now provisions every collection listed above.
2. Validation is intentionally lenient (`validationAction="warn"`) so existing sandboxes are not blocked while the workspace UI is still evolving.
3. Indexes focus on the most common filters discussed during design (e.g., by `workspace_id`, `status`, `session_id`, `user_id`). When routes are implemented we can extend or refine them based on profiler output.
4. Repositories can now be created under `src/data/repositories/` following the existing base classes. Prefer one repository per collection for clarity.

## 5. Next steps

- Implement repository + service layers for the new collections (watchlists, ideas, sessions, etc.).
- Expose CRUD endpoints/Socket.IO events through new Flask blueprints.
- Backfill tests that exercise the schema manager so CI catches missing registrations early.
- Keep this document updated whenever the data model evolves.
